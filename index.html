<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Medicine Billing System</title>
<style>
  body { font-family: sans-serif; margin: 20px; background:#f8f8f8; }
  h2 { text-align:center; color:#333; margin-bottom:18px; }
  table { width:98%; margin:0 auto 18px; border-collapse:collapse; background:#fff; box-shadow:0 0 8px rgba(0,0,0,0.08); }
  th, td { border:1px solid #ddd; padding:8px; text-align:center; font-size:13px; }
  th { background:#f2f2f2; font-weight:600; }
  input[type="number"], input[type="text"], input[type="date"], select { width:100px; padding:6px; border:1px solid #ccc; border-radius:4px; }
  input[readonly] { background:#e9ecef; cursor:not-allowed; }
  button { padding:8px 12px; border:none; border-radius:6px; cursor:pointer; font-size:14px; }
  #addRowBtn { background:#28a745; color:#fff; margin-left:4%; }
  #clearBtn { background:#ffc107; color:#fff; margin-left:8px; }
  .deleteBtn { background:#dc3545; color:#fff; padding:6px 8px; font-size:13px; }
  h3 { text-align:right; margin-right:4%; color:#333; }
  span#grandTotal { font-weight:700; color:#0b63d6; }
</style>
</head>
<body>

<h2>Medicine Billing System with Stock Management</h2>

<table id="medicineTable">
  <thead>
    <tr>
      <th>Medicine</th>
      <th>HSN</th>
      <th>MFG</th>
      <th>PACK</th>
      <th>BATCH</th>
      <th>EXP</th>
      <th>MRP</th>
      <th>Available Qty</th>
      <th>Sold Qty</th>
      <th>Remaining Qty</th>
      <th>Amount</th>
      <th>GST %</th>
      <th>GST Amt</th>
      <th>Total</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<br>
<button id="addRowBtn">+ Add Row</button>
<button id="clearBtn">Clear All</button>

<h3>Grand Total: <span id="grandTotal">0.00</span></h3>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAd1qXo8APVgZJK5D4slVQBah-5aXtqexQ",
  authDomain: "ayurvedicpharma-337a3.firebaseapp.com",
  databaseURL: "https://ayurvedicpharma-337a3-default-rtdb.firebaseio.com/",
  projectId: "ayurvedicpharma-337a3",
  storageBucket: "ayurvedicpharma-337a3.firebasestorage.app",
  messagingSenderId: "638005968627",
  appId: "1:638005968627:web:4d77bf7b6baf9b7bff4186"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* Medicine Database (from your image) */
const medicineDB = [
  {"HSN":"30049011","MFG":"DR","PRODUCT":"777 OIL (JRK)","PACK":"100","BATCH":"666/25","EXP":"4/28","MRP":285.00,"QTY":11},
  {"HSN":"30049011","MFG":"SHR","PRODUCT":"AMLAPITTA MISHRAN (DOOT)","PACK":"200","BATCH":"DP0125052","EXP":"6/28","MRP":177.00,"QTY":6},
  {"HSN":"30049011","MFG":"ARY","PRODUCT":"AMRUTOTTARAM KASHAYAM","PACK":"200ml","BATCH":"L18794","EXP":"5/27","MRP":125.00,"QTY":5},
  {"HSN":"30049011","MFG":"ARY","PRODUCT":"AMRUTOTTARAM KASHAYAM","PACK":"200ml","BATCH":"L20493","EXP":"12/27","MRP":125.00,"QTY":6},
  {"HSN":"30049011","MFG":"ARY","PRODUCT":"ARTHORUB LINIMENT (AVN)","PACK":"30ml","BATCH":"L20499","EXP":"2/28","MRP":79.69,"QTY":10},
  {"HSN":"30049011","MFG":"BV","PRODUCT":"BHRINGAMALAK TAIL (BV P)","PACK":"100","BATCH":"2909","EXP":"2/28","MRP":131.25,"QTY":10},
  {"HSN":"30049011","MFG":"VAS","PRODUCT":"DAZZLE OIL (VASU)","PACK":"60ml","BATCH":"483","EXP":"3/28","MRP":140.00,"QTY":6}
];

let saveTimeout;
function saveTableDebounced() { clearTimeout(saveTimeout); saveTimeout = setTimeout(saveTable, 800); }

function addRow(data = null) {
  const tbody = document.querySelector("#medicineTable tbody");
  const row = document.createElement("tr");
  row.innerHTML = `
    <td>
      <select class="medicine">
        <option value="" disabled selected>Select</option>
        ${medicineDB.map(m => `<option data-hsn="${m.HSN}" data-mfg="${m.MFG}" data-pack="${m.PACK}" data-batch="${m.BATCH}" data-exp="${m.EXP}" data-mrp="${m.MRP}" data-stock="${m.QTY}">${m.PRODUCT}</option>`).join('')}
      </select>
    </td>
    <td><input type="text" class="hsn" readonly></td>
    <td><input type="text" class="mfg" readonly></td>
    <td><input type="text" class="pack" readonly></td>
    <td><input type="text" class="batch" readonly></td>
    <td><input type="text" class="exp" placeholder="MM/YY or YYYY-MM" readonly></td>
    <td><input type="number" class="price" value="0.00" readonly></td>
    <td><input type="number" class="stock" value="11" readonly></td>
    <td><input type="number" class="qty" value="1" min="1"></td>
    <td><input type="number" class="remaining" value="0" readonly></td>
    <td><input type="number" class="amount" value="0.00" readonly></td>
    <td><input type="number" class="gst" value="12" min="0" max="100"></td>
    <td><input type="number" class="gstAmount" value="0.00" readonly></td>
    <td><input type="number" class="total" value="0.00" readonly></td>
    <td><button class="deleteBtn">Delete</button></td>
  `;
  tbody.appendChild(row);

  const sel = row.querySelector(".medicine");
  const inputHSN = row.querySelector(".hsn");
  const inputMFG = row.querySelector(".mfg");
  const inputPACK = row.querySelector(".pack");
  const inputBATCH = row.querySelector(".batch");
  const inputEXP = row.querySelector(".exp");
  const inputPrice = row.querySelector(".price");
  const inputStock = row.querySelector(".stock");
  const inputQty = row.querySelector(".qty");
  const inputRemain = row.querySelector(".remaining");
  const inputGST = row.querySelector(".gst");

  sel.addEventListener("change", () => {
    const opt = sel.options[sel.selectedIndex];
    inputHSN.value = opt.dataset.hsn || "";
    inputMFG.value = opt.dataset.mfg || "";
    inputPACK.value = opt.dataset.pack || "";
    inputBATCH.value = opt.dataset.batch || "";
    const exp = opt.dataset.exp || "";
    if (exp.includes("/")) {
      const [m,y] = exp.split("/");
      inputEXP.value = `20${y}-${m.padStart(2,"0")}-01`;
    }
    inputPrice.value = parseFloat(opt.dataset.mrp || 0).toFixed(2);
    inputStock.value = parseInt(opt.dataset.stock || 0);
    inputQty.value = 1;
    inputRemain.value = parseInt(opt.dataset.stock || 0) - 1;
    updateRow(row);
  });

  inputQty.addEventListener("input", () => updateRow(row));
  inputGST.addEventListener("input", () => updateRow(row));

  row.querySelector(".deleteBtn").addEventListener("click", () => {
    row.remove();
    updateGrandTotal();
    saveTable();
  });

  if (data) {
    // Load saved data
    for (let i = 0; i < sel.options.length; i++) {
      if (sel.options[i].textContent.trim() === data.name.trim()) {
        sel.selectedIndex = i; break;
      }
    }
    inputHSN.value = data.hsn || "";
    inputMFG.value = data.mfg || "";
    inputPACK.value = data.pack || "";
    inputBATCH.value = data.batch || "";
    inputEXP.value = data.exp || "";
    inputPrice.value = parseFloat(data.mrp || 0).toFixed(2);
    inputStock.value = parseInt(data.stock || 0);
    inputQty.value = data.qty || 1;
    inputRemain.value = data.remaining || (parseInt(data.stock || 0) - (data.qty || 1));
    inputGST.value = data.gst || 12;
    updateRow(row);
  }
}

function updateRow(row) {
  const price = parseFloat(row.querySelector(".price").value || 0);
  const qty = parseInt(row.querySelector(".qty").value || 0);
  const stock = parseInt(row.querySelector(".stock").value || 0);
  const gst = parseFloat(row.querySelector(".gst").value || 0);

  const remain = Math.max(stock - qty, 0);
  row.querySelector(".remaining").value = remain;

  const amount = price * qty;
  const gstAmt = amount * (gst/100);
  const total = amount + gstAmt;

  row.querySelector(".amount").value = amount.toFixed(2);
  row.querySelector(".gstAmount").value = gstAmt.toFixed(2);
  row.querySelector(".total").value = total.toFixed(2);

  updateGrandTotal();
  saveTableDebounced();
}

function updateGrandTotal() {
  let total = 0;
  document.querySelectorAll(".total").forEach(t => total += parseFloat(t.value || 0));
  document.getElementById("grandTotal").textContent = total.toFixed(2);
}

function saveTable() {
  const data = [];
  document.querySelectorAll("#medicineTable tbody tr").forEach(row => {
    const sel = row.querySelector(".medicine");
    if (sel.selectedIndex > 0) {
      data.push({
        name: sel.options[sel.selectedIndex].textContent,
        hsn: row.querySelector(".hsn").value,
        mfg: row.querySelector(".mfg").value,
        pack: row.querySelector(".pack").value,
        batch: row.querySelector(".batch").value,
        exp: row.querySelector(".exp").value,
        mrp: parseFloat(row.querySelector(".price").value),
        stock: parseInt(row.querySelector(".stock").value),
        qty: parseInt(row.querySelector(".qty").value),
        remaining: parseInt(row.querySelector(".remaining").value),
        gst: parseFloat(row.querySelector(".gst").value)
      });
    }
  });
  db.ref("billingData").set(data);
}

function loadTable() {
  db.ref("billingData").once("value").then(snap => {
    const data = snap.val();
    const tbody = document.querySelector("#medicineTable tbody");
    tbody.innerHTML = "";
    if (data) data.forEach(d => addRow(d));
    else addRow();
    updateGrandTotal();
  });
}

document.getElementById("addRowBtn").addEventListener("click", ()=> addRow());
document.getElementById("clearBtn").addEventListener("click", ()=> { db.ref("billingData").remove(); loadTable(); });
document.addEventListener("DOMContentLoaded", loadTable);
</script>

</body>
</html>
